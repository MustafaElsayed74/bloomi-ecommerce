<div class="admin-coupons-container">
    <!-- Header -->
    <div class="page-header">
        <h1>üéüÔ∏è Coupon Management</h1>
        <button class="btn btn-primary" (click)="openCreateForm()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
            Generate New Coupon
        </button>
    </div>

    <!-- Messages -->
    <div *ngIf="successMessage" class="alert alert-success">
        {{ successMessage }}
    </div>
    <div *ngIf="errorMessage" class="alert alert-error">
        {{ errorMessage }}
    </div>

    <!-- Create/Edit Form -->
    <div *ngIf="showCreateForm" class="modal-overlay" (click)="closeForm()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>{{ editingCoupon ? 'Edit Coupon' : 'Generate New Coupon' }}</h2>
                <button class="close-btn" (click)="closeForm()">√ó</button>
            </div>

            <form class="coupon-form" (ngSubmit)="saveCoupon()">
                <div class="form-row">
                    <div class="form-group">
                        <label for="code">Coupon Code *</label>
                        <input type="text" id="code" [(ngModel)]="newCoupon.code" name="code"
                            placeholder="e.g., SUMMER2024" required [style.text-transform]="'uppercase'">
                    </div>

                    <div class="form-group">
                        <label for="discountType">Discount Type *</label>
                        <select id="discountType" [(ngModel)]="newCoupon.discountType" name="discountType" required>
                            <option [value]="DiscountType.Percentage">Percentage</option>
                            <option [value]="DiscountType.FixedAmount">Fixed Amount</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" [(ngModel)]="newCoupon.description" name="description"
                        placeholder="e.g., Summer sale - 20% off all products" rows="2" required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="discountValue">
                            {{ newCoupon.discountType === DiscountType.Percentage ? 'Discount (%)' : 'Discount Amount
                            (EGP)' }} *
                        </label>
                        <input type="number" id="discountValue" [(ngModel)]="newCoupon.discountValue"
                            name="discountValue" [min]="0"
                            [max]="newCoupon.discountType === DiscountType.Percentage ? 100 : 999999" step="0.01"
                            required>
                    </div>

                    <div class="form-group">
                        <label for="minOrder">Minimum Order Amount (EGP)</label>
                        <input type="number" id="minOrder" [(ngModel)]="newCoupon.minimumOrderAmount" name="minOrder"
                            min="0" step="0.01" placeholder="Optional">
                    </div>
                </div>

                <div class="form-row" *ngIf="newCoupon.discountType === DiscountType.Percentage">
                    <div class="form-group">
                        <label for="maxDiscount">Maximum Discount Amount (EGP)</label>
                        <input type="number" id="maxDiscount" [(ngModel)]="newCoupon.maximumDiscountAmount"
                            name="maxDiscount" min="0" step="0.01" placeholder="Optional">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="expiration">Expiration Date</label>
                        <input type="datetime-local" id="expiration" [(ngModel)]="newCoupon.expirationDate"
                            name="expiration">
                    </div>

                    <div class="form-group">
                        <label for="maxUsage">Maximum Usage Count</label>
                        <input type="number" id="maxUsage" [(ngModel)]="newCoupon.maxUsageCount" name="maxUsage" min="1"
                            placeholder="Unlimited">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" (click)="closeForm()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        {{ editingCoupon ? 'Update Coupon' : 'Generate Coupon' }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Coupons List -->
    <div *ngIf="loading" class="loading">Loading coupons...</div>

    <div *ngIf="!loading && coupons.length === 0" class="empty-state">
        <svg width="80" height="80" viewBox="0 0 80 80" fill="none">
            <path d="M40 10L10 25V55L40 70L70 55V25L40 10Z" stroke="currentColor" stroke-width="2" fill="none" />
            <circle cx="40" cy="40" r="15" stroke="currentColor" stroke-width="2" fill="none" />
        </svg>
        <p>No coupons created yet</p>
        <button class="btn btn-primary" (click)="openCreateForm()">Generate Your First Coupon</button>
    </div>

    <div *ngIf="!loading && coupons.length > 0" class="coupons-grid">
        <div *ngFor="let coupon of coupons" class="coupon-card" [class.inactive]="!coupon.isActive"
            [class.expired]="isExpired(coupon)">
            <div class="coupon-header">
                <div class="coupon-code">{{ coupon.code }}</div>
                <div class="coupon-status">
                    <span *ngIf="!coupon.isActive" class="badge badge-inactive">Inactive</span>
                    <span *ngIf="isExpired(coupon)" class="badge badge-expired">Expired</span>
                    <span *ngIf="isUsageLimitReached(coupon)" class="badge badge-limit">Limit Reached</span>
                    <span *ngIf="coupon.isActive && !isExpired(coupon)" class="badge badge-active">Active</span>
                </div>
            </div>

            <p class="coupon-description">{{ coupon.description }}</p>

            <div class="coupon-details">
                <div class="detail-item">
                    <span class="detail-label">Discount:</span>
                    <span class="detail-value highlight">{{ getDiscountDisplay(coupon) }}</span>
                </div>

                <div class="detail-item" *ngIf="coupon.minimumOrderAmount">
                    <span class="detail-label">Min. Order:</span>
                    <span class="detail-value">EGP {{ coupon.minimumOrderAmount.toFixed(2) }}</span>
                </div>

                <div class="detail-item"
                    *ngIf="coupon.maximumDiscountAmount && coupon.discountType === DiscountType.Percentage">
                    <span class="detail-label">Max. Discount:</span>
                    <span class="detail-value">EGP {{ coupon.maximumDiscountAmount.toFixed(2) }}</span>
                </div>

                <div class="detail-item" *ngIf="coupon.expirationDate">
                    <span class="detail-label">Expires:</span>
                    <span class="detail-value">{{ coupon.expirationDate | date:'short' }}</span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Usage:</span>
                    <span class="detail-value">
                        {{ coupon.usageCount }}{{ coupon.maxUsageCount ? ' / ' + coupon.maxUsageCount : ' (Unlimited)'
                        }}
                    </span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Created:</span>
                    <span class="detail-value">{{ coupon.createdAt | date:'short' }}</span>
                </div>
            </div>

            <div class="coupon-actions">
                <button class="btn-icon btn-edit" (click)="openEditForm(coupon)" title="Edit">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <path d="M12.5 2.5L15.5 5.5L6 15H3V12L12.5 2.5Z" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </button>
                <button class="btn-icon" [class.btn-activate]="!coupon.isActive"
                    [class.btn-deactivate]="coupon.isActive" (click)="toggleActive(coupon)"
                    [title]="coupon.isActive ? 'Deactivate' : 'Activate'">
                    <svg *ngIf="coupon.isActive" width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <path d="M9 3V9M9 9V15M9 9H15M9 9H3" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" />
                    </svg>
                    <svg *ngIf="!coupon.isActive" width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <path d="M3 9L7 13L15 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </button>
                <button class="btn-icon btn-delete" (click)="deleteCoupon(coupon.id)" title="Delete">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <path d="M3 5H15M7 8V13M11 8V13M5 5L6 15H12L13 5" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>