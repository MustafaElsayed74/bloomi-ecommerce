<div class="profile-wrapper">
    <div class="profile-card" [class.loading]="isLoading">
        <div class="profile-header">
            <div class="title-block">
                <p class="eyebrow">Account</p>
                <h1>Profile Settings</h1>
                <p class="subtitle">Update your personal info and how others see you.</p>
            </div>
            <div class="avatar-block">
                <div class="avatar-wrapper">
                    <img [src]="profilePicture || 'https://ui-avatars.com/api/?name=' + (name || 'User')" [alt]="name"
                        class="avatar" />
                    <button type="button" class="avatar-upload-btn" (click)="triggerFileInput()"
                        [disabled]="isUploadingPicture">
                        <svg *ngIf="!isUploadingPicture" width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path
                                d="M14 10v2.667A1.333 1.333 0 0112.667 14H3.333A1.333 1.333 0 012 12.667V10M11.333 5.333L8 2m0 0L4.667 5.333M8 2v8"
                                stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                        <span *ngIf="isUploadingPicture" class="upload-spinner"></span>
                    </button>
                    <input type="file" id="profile-picture-input" accept="image/*" (change)="onFileSelected($event)"
                        style="display: none" />
                </div>
            </div>
        </div>

        <!-- Toast Notifications Container -->
        <div class="toast-container">
            <div *ngIf="errorMessage" class="toast toast-error" [@slideIn]>
                <div class="toast-icon-wrapper">
                    <svg class="toast-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path
                            d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18Z"
                            fill="currentColor" fill-opacity="0.15" />
                        <path d="M10 6V10M10 14H10.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </div>
                <div class="toast-body">
                    <div class="toast-title">Error</div>
                    <div class="toast-message">{{ errorMessage }}</div>
                </div>
                <button type="button" class="toast-close" (click)="errorMessage = ''" aria-label="Close">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <path d="M13.5 4.5L4.5 13.5M4.5 4.5L13.5 13.5" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" />
                    </svg>
                </button>
                <div class="toast-progress"></div>
            </div>

            <div *ngIf="successMessage" class="toast toast-pink" [@slideIn]>
                <div class="toast-icon-wrapper">
                    <svg class="toast-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path
                            d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18Z"
                            fill="currentColor" fill-opacity="0.15" />
                        <path d="M6 10L8.5 12.5L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="toast-body">
                    <div class="toast-title">Success</div>
                    <div class="toast-message">{{ successMessage }}</div>
                </div>
                <button type="button" class="toast-close" (click)="successMessage = ''" aria-label="Close">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <path d="M13.5 4.5L4.5 13.5M4.5 4.5L13.5 13.5" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" />
                    </svg>
                </button>
                <div class="toast-progress"></div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal-overlay" *ngIf="showDeleteModal" (click)="cancelDelete()">
            <div class="modal-content" (click)="$event.stopPropagation()">
                <div class="modal-icon">
                    <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                        <circle cx="24" cy="24" r="22" stroke="currentColor" stroke-width="3" />
                        <path d="M24 14V24M24 34H24.02" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
                    </svg>
                </div>
                <h2 class="modal-title">Remove Phone Number?</h2>
                <p class="modal-message">Are you sure you want to remove <strong>{{ phoneToDelete }}</strong> from your
                    verified numbers?</p>
                <div class="modal-actions">
                    <button type="button" class="modal-btn modal-btn-cancel" (click)="cancelDelete()">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                            <path d="M13.5 4.5L4.5 13.5M4.5 4.5L13.5 13.5" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                        </svg>
                        Cancel
                    </button>
                    <button type="button" class="modal-btn modal-btn-confirm" (click)="confirmDelete()">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                            <path d="M3 9L7.5 13.5L15 4.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                        Yes, Remove
                    </button>
                </div>
            </div>
        </div>

        <form (ngSubmit)="save()" novalidate>
            <div class="form-grid">
                <div class="form-group">
                    <label for="name">Full Name</label>
                    <input id="name" name="name" type="text" [(ngModel)]="name" required
                        [disabled]="isSaving || isLoading" />
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input id="email" name="email" type="email" [(ngModel)]="email" disabled />
                </div>
                <div class="form-group full phone-verification-section">
                    <label class="section-label">Phone Number Verification</label>
                    <p class="section-hint">Verify up to 2 phone numbers for account security</p>

                    <!-- Verified Numbers Display -->
                    <div class="verified-numbers-grid" *ngIf="verifiedPhoneNumbers.length > 0">
                        <div class="verified-card" *ngFor="let num of verifiedPhoneNumbers">
                            <div class="verified-card-header">
                                <div class="verified-icon">
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                        <path
                                            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                            fill="currentColor" />
                                    </svg>
                                </div>
                                <span class="verified-badge">Verified</span>
                            </div>
                            <div class="verified-card-body">
                                <span class="verified-phone">{{ num }}</span>
                            </div>
                            <button type="button" class="verified-card-delete" (click)="deleteVerifiedPhone(num)"
                                title="Remove this number">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M12 4L4 12M4 4l8 8" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Add New Number Section -->
                    <div class="add-number-card" [class.disabled]="verifiedPhoneNumbers.length >= 2">
                        <div class="add-number-header">
                            <span class="add-number-title">
                                {{ verifiedPhoneNumbers.length >= 2 ? 'Maximum Numbers Reached' : 'Add New Number' }}
                            </span>
                            <span class="add-number-count">{{ verifiedPhoneNumbers.length }}/2</span>
                        </div>

                        <div class="phone-input-group" *ngIf="verifiedPhoneNumbers.length < 2">
                            <div class="input-with-icon">
                                <svg class="input-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                    <path
                                        d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"
                                        fill="currentColor" opacity="0.5" />
                                </svg>
                                <input type="tel" [(ngModel)]="phoneNumber" name="phone-new" placeholder="01012345678"
                                    [disabled]="isSaving || isLoading || isSendingCode || isVerifyingCode"
                                    class="phone-input" />
                            </div>
                            <button type="button" class="btn-send-code" (click)="sendVerificationCode()"
                                [disabled]="isSaving || isLoading || isSendingCode">
                                <svg *ngIf="!isSendingCode" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M15 8L1 1L4 8L1 15L15 8Z" fill="currentColor" />
                                </svg>
                                <span class="spinner" *ngIf="isSendingCode"></span>
                                {{ isSendingCode ? 'Sending...' : 'Send Code' }}
                            </button>
                        </div>

                        <div class="verification-code-group"
                            *ngIf="verificationStatus && verifiedPhoneNumbers.length < 2">
                            <p class="verification-instruction">{{ verificationStatus }}</p>
                            <div class="code-input-group">
                                <input type="text" maxlength="6" [(ngModel)]="verificationCode" name="verificationCode"
                                    placeholder="••••••" [disabled]="isVerifyingCode || isLoading"
                                    class="code-input-field" />
                                <button type="button" class="btn-verify-code" (click)="verifyPhoneCode()"
                                    [disabled]="isVerifyingCode || isLoading || verificationCode.length !== 6">
                                    <svg *ngIf="!isVerifyingCode" width="16" height="16" viewBox="0 0 16 16"
                                        fill="none">
                                        <path
                                            d="M13.854 4.146a.5.5 0 010 .708l-7 7a.5.5 0 01-.708 0l-3.5-3.5a.5.5 0 11.708-.708L7 11.293l6.646-6.647a.5.5 0 01.708 0z"
                                            fill="currentColor" />
                                    </svg>
                                    <span class="spinner" *ngIf="isVerifyingCode"></span>
                                    {{ isVerifyingCode ? 'Verifying...' : 'Verify Code' }}
                                </button>
                            </div>
                        </div>

                        <p class="input-hint" *ngIf="verifiedPhoneNumbers.length < 2">
                            <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                                <path
                                    d="M7 0a7 7 0 100 14A7 7 0 007 0zm0 3a1 1 0 011 1v3a1 1 0 01-2 0V4a1 1 0 011-1zm0 8a1 1 0 110-2 1 1 0 010 2z"
                                    fill="currentColor" />
                            </svg>
                            Enter Egyptian mobile number starting with 01
                        </p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="address">Address</label>
                    <input id="address" name="address" type="text" [(ngModel)]="address"
                        [disabled]="isSaving || isLoading" />
                </div>
                <div class="form-group full">
                    <label for="picture">Profile Picture URL</label>
                    <input id="picture" name="picture" type="url" [(ngModel)]="profilePicture"
                        [disabled]="isSaving || isLoading" />
                    <p class="hint">Paste an image URL. Leave empty to keep current.</p>
                </div>
            </div>

            <div class="actions">
                <button type="submit" class="btn primary" [disabled]="isSaving || isLoading">
                    {{ isSaving ? 'Saving...' : 'Save Changes' }}
                </button>
                <button type="button" class="btn ghost" (click)="fetchProfile()" [disabled]="isSaving || isLoading">
                    Reload
                </button>
            </div>
        </form>
    </div>
</div>