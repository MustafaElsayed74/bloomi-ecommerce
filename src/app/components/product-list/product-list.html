<div class="container">
    <!-- Toast Notifications -->
    <div class="toast-container">
        <div *ngIf="errorMessage" class="toast toast-error">
            <div class="toast-icon-wrapper">
                <svg class="toast-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path
                        d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18Z"
                        fill="currentColor" fill-opacity="0.15" />
                    <path d="M10 6V10M10 14H10.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
            </div>
            <div class="toast-body">
                <div class="toast-title">Error</div>
                <div class="toast-message">{{ errorMessage }}</div>
            </div>
            <button type="button" class="toast-close" (click)="errorMessage = ''" aria-label="Close">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                    <path d="M13.5 4.5L4.5 13.5M4.5 4.5L13.5 13.5" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" />
                </svg>
            </button>
            <div class="toast-progress"></div>
        </div>

        <div *ngIf="successMessage" class="toast toast-success">
            <div class="toast-icon-wrapper">
                <svg class="toast-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path
                        d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18Z"
                        fill="currentColor" fill-opacity="0.15" />
                    <path d="M6 10L8.5 12.5L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </div>
            <div class="toast-body">
                <div class="toast-title">Success</div>
                <div class="toast-message">{{ successMessage }}</div>
            </div>
            <button type="button" class="toast-close" (click)="successMessage = ''" aria-label="Close">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                    <path d="M13.5 4.5L4.5 13.5M4.5 4.5L13.5 13.5" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" />
                </svg>
            </button>
            <div class="toast-progress"></div>
        </div>
    </div>

    <div class="header-section">
        <div class="title-block">
            <p class="eyebrow">Shop</p>
            <h1>Our Products</h1>
            <p class="subtitle">Browse the catalog and find the right fit faster.</p>
        </div>

        <div class="filters-card">
            <div class="filters-row">
                <div class="category-filter">
                    <label for="category-select">Category</label>
                    <select id="category-select" class="category-select" [(ngModel)]="selectedCategory"
                        (change)="onCategoryChange(selectedCategory)">
                        <option value="">All Categories</option>
                        <option *ngFor="let category of categories" [value]="category">{{ category }}</option>
                    </select>
                </div>

                <div class="sort-container">
                    <label for="sort-select">Sort</label>
                    <select id="sort-select" class="sort-select" [(ngModel)]="sortBy"
                        (change)="loadProducts(searchTerm, selectedCategory)">
                        <option value="">Default</option>
                        <option value="price-asc">Price: Low to High</option>
                        <option value="price-desc">Price: High to Low</option>
                        <option value="name-asc">Name: A to Z</option>
                        <option value="name-desc">Name: Z to A</option>
                        <option value="rating-desc">Highest Rated</option>
                        <option value="newest">Newest First</option>
                    </select>
                </div>
            </div>

            <div class="meta-row" *ngIf="!loading && totalItems">
                <span class="chip filled">{{ totalItems }} items</span>
                <span class="chip subtle">Page {{ currentPage }} of {{ totalPages || 1 }}</span>
            </div>
        </div>
    </div>

    <div *ngIf="loading" class="loading">
        Loading products...
    </div>
</div>

<div *ngIf="error" class="error">
    {{ error }}
</div>

<div *ngIf="!loading && products.length > 0" class="products-grid">
    <div *ngFor="let product of products" class="product-card">
        <div class="product-image">
            <img [src]="product.imageUrl" [alt]="product.name" />
            <span class="badge stock" *ngIf="product.stock === 0">Sold out</span>
        </div>
        <div class="product-info">
            <div class="card-top">
                <h3>{{ product.name }}</h3>
                <p class="category">{{ product.category }}</p>
            </div>

            <p class="description">{{ product.description }}</p>

            <div class="product-footer">
                <span class="price">EGP {{ product.price.toFixed(2) }}</span>
                <span class="rating">‚≠ê {{ product.rating }}</span>
            </div>

            <button (click)="addToCart(product)" [disabled]="product.stock === 0" class="btn-primary-full">
                {{ product.stock > 0 ? 'Add to Cart' : 'Out of Stock' }}
            </button>

            <div class="actions-secondary">
                <a [routerLink]="['/product', product.id]" class="link-action">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
                        <path
                            d="M10 12C11.1046 12 12 11.1046 12 10C12 8.89543 11.1046 8 10 8C8.89543 8 8 8.89543 8 10C8 11.1046 8.89543 12 10 12Z"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        <path
                            d="M17.5 10C15.5 13.5 13 15 10 15C7 15 4.5 13.5 2.5 10C4.5 6.5 7 5 10 5C13 5 15.5 6.5 17.5 10Z"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    View Details
                </a>
                <button type="button" class="link-action" (click)="toggleWishlist(product)">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none">
                        <path
                            d="M10 17.5C10 17.5 2.5 13 2.5 7.5C2.5 5.84315 3.84315 4.5 5.5 4.5C6.88071 4.5 8.03906 5.35645 8.5 6.5C8.96094 5.35645 10.1193 4.5 11.5 4.5C13.1569 4.5 14.5 5.84315 14.5 7.5C14.5 13 10 17.5 10 17.5Z"
                            [attr.fill]="isInWishlist(product.id) ? 'currentColor' : 'none'" stroke="currentColor"
                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    {{ isInWishlist(product.id) ? 'Saved' : 'Save' }}
                </button>
            </div>
        </div>
    </div>

    <div *ngIf="!loading && products.length === 0" class="empty">
        No products available.
    </div>
</div>

<!-- Pagination Controls -->
<div *ngIf="!loading && totalPages > 1" class="pagination-container">
    <div class="pagination-info">
        Showing {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, totalItems) }} of {{
        totalItems }} products
    </div>

    <div class="pagination">
        <button class="pagination-btn prev-btn" [disabled]="currentPage === 1" (click)="previousPage()"
            [class.disabled]="currentPage === 1">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>
            Previous
        </button>

        <button *ngIf="getPageNumbers()[0] > 1" class="pagination-btn page-btn" (click)="goToPage(1)">
            1
        </button>

        <span *ngIf="getPageNumbers()[0] > 2" class="pagination-ellipsis">...</span>

        <button *ngFor="let page of getPageNumbers()" class="pagination-btn page-btn"
            [class.active]="page === currentPage" (click)="goToPage(page)">
            {{ page }}
        </button>

        <span *ngIf="getPageNumbers()[getPageNumbers().length - 1] < totalPages - 1"
            class="pagination-ellipsis">...</span>

        <button *ngIf="getPageNumbers()[getPageNumbers().length - 1] < totalPages" class="pagination-btn page-btn"
            (click)="goToPage(totalPages)">
            {{ totalPages }}
        </button>

        <button class="pagination-btn next-btn" [disabled]="currentPage === totalPages" (click)="nextPage()"
            [class.disabled]="currentPage === totalPages">
            Next
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>
        </button>
    </div>
</div>